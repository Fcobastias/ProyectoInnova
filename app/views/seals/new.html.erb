

<!-- app/views/seals/new.html.erb -->
<section class="section hero-sealai is-flex is-align-items-center is-justify-content-center">
  <div class="container has-text-centered" style="position:relative; z-index:1;">
    <%= link_to "← Volver", root_path, class: "button is-primary is-small mb-4" %>

    <h1 class="title is-3 has-text-centered has-text-primary">Validar Sello</h1>
    <p class="subtitle is-6 has-text-centered">Concede acceso a tu cámara para comenzar.</p>

    <div class="box" style="max-width:720px; margin:0 auto; position:relative; border-radius:12px;">
      <video id="preview" playsinline muted autoplay style="width:100%; border-radius:12px;"></video>

      <!-- Overlay de carga -->
      <div id="loader" class="sealai-overlay is-hidden-flex">
        <div>
          <div class="sealai-spinner" aria-hidden="true"></div>
          <p class="mt-3 has-text-grey">Cargando…</p>
        </div>
      </div>
    </div>

    <p id="status" class="has-text-centered has-text-grey mt-4 is-size-7">
      Solicitando permiso de cámara…
    </p>
  </div>
</section>

<style>
/* Overlay y spinner (carga circular) */
.sealai-overlay {
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.85);
  border-radius: 12px;
  display: flex;
  align-items: center; justify-content: center;
}

.is-hidden-flex { display: none !important; }

.sealai-spinner {
  width: 56px;
  height: 56px;
  border: 4px solid rgba(0,0,0,0.15);
  border-top-color: rgba(0,0,0,0.7);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const statusEl = document.getElementById('status');
  const video = document.getElementById('preview');
  const loader = document.getElementById('loader');

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }
    });
    video.srcObject = stream;
    await video.play();
    statusEl.textContent = 'Cámara habilitada. Escanee el sello.';

    loader.classList.add('is-hidden-flex');

    setTimeout(() => {
        loader.classList.remove('is-hidden-flex');
        statusEl.textContent = 'Sello leido. Procesando imagen con el modelo de IA…';

        // Congelar frame
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        video.pause(); // detiene reproducción sin apagar cámara
        video.srcObject = null; // libera el elemento video
        video.poster = canvas.toDataURL('image/png'); // usa la imagen congelada
    }, 5000);

    setTimeout(() => {
        statusEl.textContent = 'Procesamiento terminado. Redirigiendo...';
    }, 8500);

    const nextUrl = "<%= resultado_sello_path %>";
    sealaiNavTimer = setTimeout(() => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      if (window.Turbo && typeof Turbo.visit === 'function') {
        Turbo.visit(nextUrl);
      } else {
        window.location.assign(nextUrl);
      }
    }, 10000);

  } catch (err) {
    statusEl.textContent = 'No se pudo acceder a la cámara. Revisa permisos del navegador.';
  }

  // Cerramos la cámara en caso de que el usuario se salga
  window.addEventListener('beforeunload', () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  });
});
</script>
